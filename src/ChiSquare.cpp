#include "ChiSquare.hpp"

namespace tops {

  double CHI_QUARE[31][9] = {
    {0.00098, 1.64, 2.71, 3.84, 5.02, 6.63, 7.88, 10.83, 12.12},
    {0.051, 3.22, 4.61, 5.99, 7.38, 9.21, 10.60, 13.82, 15.20},
    {0.216, 4.64, 6.25, 7.81, 9.35, 11.34, 12.84, 16.27, 17.73},
    {0.48, 5.99, 7.78, 9.49, 11.14, 13.28, 14.86, 18.47, 20.00},
    {0.83, 7.29, 9.24, 11.07, 12.83, 15.09, 16.75, 20.51, 22.11},
    {1.24, 8.56, 10.64, 12.59, 14.45, 16.81, 18.55, 22.46, 24.10},
    {1.69, 9.80, 12.02, 14.07, 16.01, 18.48, 20.28, 24.32, 26.02},
    {2.18, 11.03, 13.36, 15.51, 17.53, 20.09, 21.95, 26.12, 27.87},
    {2.70, 12.24, 14.68, 16.92, 19.02, 21.67, 23.59, 27.88, 29.67},
    {3.25, 13.44, 15.99, 18.31, 20.48, 23.21, 25.19, 29.59, 31.42},
    {3.82, 14.63, 17.28, 19.68, 21.92, 24.73, 26.76, 31.26, 33.14},
    {4.40, 15.81, 18.55, 21.03, 23.34, 26.22, 28.30, 32.91, 34.82},
    {5.01, 16.98, 19.81, 22.36, 24.74, 27.69, 29.82, 34.53, 36.48},
    {5.63, 18.15, 21.06, 23.68, 26.12, 29.14, 31.32, 36.12, 38.11},
    {6.26, 19.31, 22.31, 25.00, 27.49, 30.58, 32.80, 37.70, 39.72},
    {6.91, 20.47, 23.54, 26.30, 28.85, 32.00, 34.27, 39.25, 41.31},
    {7.56, 21.61, 24.77, 27.59, 30.19, 33.41, 35.72, 40.79, 42.88},
    {8.23, 22.76, 25.99, 28.87, 31.53, 34.81, 37.16, 42.31, 44.43},
    {8.91, 23.90, 27.20, 30.14, 32.85, 36.19, 38.58, 43.82, 45.97},
    {9.59, 25.04, 28.41, 31.41, 34.17, 37.57, 40.00, 45.31, 47.50},
    {10.28, 26.17, 29.62, 32.67, 35.48, 38.93, 41.40, 46.80, 49.01},
    {10.98, 27.30, 30.81, 33.92, 36.78, 40.29, 42.80, 48.27, 50.51},
    {11.69, 28.43, 32.01, 35.17, 38.08, 41.64, 44.18, 49.73, 52.00},
    {12.40, 29.55, 33.20, 36.42, 39.36, 42.98, 45.56, 51.18, 53.48},
    {13.12, 30.68, 34.38, 37.65, 40.65, 44.31, 46.93, 52.62, 54.95},
    {16.79, 36.25, 40.26, 43.77, 46.98, 50.89, 53.67, 59.70, 62.16},
    {24.43, 47.27, 51.81, 55.76, 59.34, 63.69, 66.77, 73.40, 76.10},
    {32.36, 58.16, 63.17, 67.50, 71.42, 76.15, 79.49, 86.66, 89.56},
    {40.48, 68.97, 74.40, 79.08, 83.30, 88.38, 91.95, 99.61, 102.7},
    {57.15, 90.41, 96.58, 101.9, 106.6, 112.3, 116.3, 124.8, 128.3},
    {74.22, 111.7, 118.5, 124.3, 129.6, 135.8, 140.2, 149.4, 153.2}
  };

  int chiPi(double p) {
    double prob[] = {0.975, 0.2, 0.1, 0.05, 0.025, 0.01, 0.005, 0.001, 0.0005};
    int pi = 0;
    for (int i = 0; i < 9; i++) {
      if (p >= prob[i]) {
        if (i == 0)
          pi = 0;
        else if (abs(p - prob[i]) > abs(p - prob[i-1]))
          pi = i-1;
        else
          pi = i;
        break;
      }
    }
    return pi;
  }

  int chiDfi(int df) {
    if (df <= 25)
      return df-1;

    int dfi = 30;
    while ((df - dfi) > 0) {
      dfi += 10;
      if (dfi == 80) {
        if (abs(df - 80) > abs(df - 100))
          return 30;
        else
          return 29;
      }
    }
    return ((dfi - 30)/10 + 25);
  }

  double chi(double p, int df) {
    int pi = chiPi(p);
    int dfi = chiDfi(df);
    return CHI_QUARE[dfi][pi];
  }
}